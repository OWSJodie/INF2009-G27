<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .top-bar button {
            padding: 10px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .top-bar button:hover {
            background-color: #c0392b;
        }

        .user-card {
            background-color: #fafafa;
            border: 1px solid #ddd;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        button {
            background-color: #27ae60;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            font-weight: bold;
            margin-top: 8px;
        }

        button:hover {
            background-color: #219150;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-buttons button {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .promote-btn {
            background-color: #3498db;
            color: white;
        }

        .promote-btn:hover {
            background-color: #2980b9;
        }


.left-content {
        font-size: 16px;
    }

    .right-content {
        display: flex;
        align-items: center;
    }

    .right-content button {
        padding: 8px 16px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s ease;
        width: auto; /* ✅ Fix stretch issue */
    }

    .right-content button:hover {
        background-color: #c0392b;
    }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="left-content">
        <span id="admin-email"></span>
    </div>
    <div class="right-content">
        <button onclick="logout()">Logout</button>
    </div>
</div>


<h1>Admin Dashboard</h1>

<div class="container" id="user-list"></div>

<script>
    // ✅ Load Users (GET Request)
    async function loadUsers() {
        const userEmail = localStorage.getItem('userEmail');
        const response = await fetch(`/admin/users?email=${userEmail}`);
        const data = await response.json();

        if (data.status === 'success') {
            const userList = data.data.map(user => `
                <div class="user-card">
                    <input type="email" value="${user.email}" disabled />
                    <input type="text" value="${user.name || ''}" id="name-${user.id}" placeholder="Name" />
                    
                    <!-- ✅ Only admins can edit RFID -->
                    <input type="text" class="rfid-input" value="${user.rfid || ''}" id="rfid-${user.id}" placeholder="RFID" />
                    
                    <select id="role-${user.id}">
                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>

                    <div class="action-buttons">
                        <button class="update-btn" onclick="updateUser('${user.id}')">Update</button>
                        <button class="delete-btn" onclick="deleteUser('${user.id}')">Delete</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('user-list').innerHTML = userList;

            // ✅ Hide RFID field for non-admins
            if (userEmail !== 'admin@t.com') {
                document.querySelectorAll('.rfid-input').forEach(el => el.style.display = 'none');
            }
        } else {
            alert(data.message);
        }
    }

    // ✅ Update User Data (PUT Request)
    async function updateUser(email) {
        const name = document.getElementById(`name-${email}`).value;
        const rfid = document.getElementById(`rfid-${email}`)?.value || '';
        const role = document.getElementById(`role-${email}`).value;

        const response = await fetch(`/admin/users/${email}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, rfid, role })
        });

        const result = await response.json();
        alert(result.message);
        loadUsers(); // ✅ Refresh user list after update
    }

    // ✅ Delete User (DELETE Request)
    async function deleteUser(email) {
        if (!confirm("Are you sure you want to delete this user?")) return;
        
        const response = await fetch(`/admin/users/${email}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        alert(result.message);
        loadUsers(); // ✅ Refresh list after deletion
    }

    // ✅ Logout (POST Request)
    async function logout() {
        const response = await fetch('/logout', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.status === 'success') {
            localStorage.removeItem('userEmail');
            window.location.href = "/login"; // ✅ Redirect to login
        } else {
            alert(data.message);
        }
    }

    // ✅ Display logged-in admin email
    document.getElementById('admin-email').textContent = localStorage.getItem('userEmail');

    // ✅ Load users on page load
    loadUsers();
</script>

</body>
</html>
